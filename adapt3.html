<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Course Player</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.6/purify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
<script src="https://www.google.com/recaptcha/enterprise.js?render=6LcQhFMrAAAAAMjWClxXSNDpZrFZj3rUrz5UHhWA"></script>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: "#4F46E5",
                            light: "#6366F1",
                            dark: "#4338CA",
                        },
                        "background-light": "#F9FAFB",
                        "background-dark": "#111827",
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#1F2937",
                        "text-light": "#111827",
                        "text-dark": "#F9FAFB",
                        "subtle-light": "#6B7280",
                        "subtle-dark": "#9CA3AF",
                        "border-light": "#E5E7EB",
                        "border-dark": "#374151",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.5rem",
                    },
                },
            },
        };
    </script>
    <style>
        /* Chat-specific styles */
        #adapt-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        #chat-panel {
            flex-grow: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
        }

        .message-content {
            padding: 10px 14px;
            border-radius: 16px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 0.9rem;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.user .message-content {
            background-color: #4F46E5;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.bot {
            align-items: flex-start;
        }

        .message.bot .message-content {
            background-color: #F3F4F6;
            color: #111827;
            border-bottom-left-radius: 4px;
        }

        .dark .message.bot .message-content {
            background-color: #374151;
            color: #F9FAFB;
        }
        
        .message-sender {
            font-size: 0.75rem;
            color: #6B7280;
            margin-bottom: 4px;
            padding: 0 4px;
        }

        .dark .message-sender {
            color: #9CA3AF;
        }

        .message.user .message-sender {
            text-align: right;
        }

        .message.bot .message-sender {
            text-align: left;
        }

        .thinking-gif {
            width: 24px;
            height: 24px;
        }

        code {
            background-color: #F3F4F6;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', Monaco, monospace;
            font-size: 0.85em;
        }

        .dark code {
            background-color: #374151;
        }

        pre {
            background-color: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            overflow-x: auto;
            line-height: 1.4;
        }

        .dark pre {
            background-color: #1F2937;
            border-color: #374151;
        }

        pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            font-size: 0.85em;
        }

        .bot-typing-content {
            opacity: 0;
            display: block;
            white-space: pre-wrap;
        }

        .bot-typing-content.fade-in {
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        .anim-letter {
            opacity: 0;
            transition: opacity 0.15s ease-out;
        }

        /* Collapsible panel animation */
        .chat-sidebar {
            transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .chat-sidebar.collapsed {
            width: 0px !important;
            opacity: 0;
            overflow: hidden;
        }

        .toggle-btn {
            transition: transform 0.3s ease-in-out;
        }

        .toggle-btn.collapsed {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark">
<div class="flex flex-col h-screen">
<header class="flex items-center justify-between p-4 border-b bg-surface-light dark:bg-surface-dark border-border-light dark:border-border-dark">
<div class="flex items-center gap-4">
<img src="logo.png" alt="Logo" class="w-10 h-10 rounded object-contain">
<div>
<h1 class="text-lg font-bold">2.2 Few-Shot Prompting</h1>
<p class="text-sm text-subtle-light dark:text-subtle-dark">Unit 2: Prompt Engineering | Foundational Prompting Techniques</p>
</div>
<div class="flex items-center gap-2 ml-4 text-sm text-subtle-light dark:text-subtle-dark">
<span class="material-icons text-base">schedule</span>
<span>2-day lesson</span>
<span class="material-icons text-base ml-2">lock_open</span>
</div>
</div>
<div class="flex items-center gap-4">
<button id="toggle-chat" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 toggle-btn" title="Toggle Chat Panel">
<span class="material-icons text-subtle-light dark:text-subtle-dark">chat</span>
</button>
<button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors">
<span>Continue</span>
<span class="material-icons">arrow_forward</span>
</button>
</div>
</header>
<div class="flex flex-1 overflow-hidden">
<main id="main-content" class="flex-1 bg-background-light dark:bg-background-dark overflow-hidden transition-all duration-300">
<iframe id="adapt-frame" src="assets/foundational-prompting-techniques/index.html" title="Foundational Prompting Techniques Course" allowfullscreen></iframe>
</main>
<aside id="chat-sidebar" class="w-96 bg-surface-light dark:bg-surface-dark border-l border-border-light dark:border-border-dark flex flex-col chat-sidebar">
<div class="flex items-center justify-between p-3 border-b border-border-light dark:border-border-dark">
<h3 class="text-sm font-semibold text-subtle-light dark:text-subtle-dark">PROMPT PLAYGROUND</h3>
<button id="close-chat" class="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800">
<span class="material-icons text-subtle-light dark:text-subtle-dark text-sm">close</span>
</button>
</div>
<div class="flex items-center justify-between p-3 border-b border-border-light dark:border-border-dark">
<select id="model-selector" class="flex-1 px-3 py-2 text-sm border border-border-light dark:border-border-dark rounded-lg bg-surface-light dark:bg-surface-dark text-text-light dark:text-text-dark mr-2">
<option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite</option>
<option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite</option>
<option value="gemini-2.0-flash">gemini-2.0-flash</option>
<option value="gemini-1.5-flash">gemini-1.5-flash</option>
<option value="gemini-2.5-flash">gemini-2.5-flash</option>
<option value="gemini-2.5-pro">gemini-2.5-pro</option>
<option value="perplexity-sonar">Perplexity Sonar</option>
</select>
<button id="new-chat-button" class="px-3 py-2 text-sm bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors whitespace-nowrap">
New
</button>
</div>
<div id="chat-panel" class="flex-1 overflow-y-auto"></div>
<form id="chat-form" class="p-3 border-t border-border-light dark:border-border-dark pb-20">
<div class="flex gap-2">
<input type="text" id="chat-input" placeholder="Type your message..." required 
class="flex-1 px-4 py-2 text-sm border border-border-light dark:border-border-dark rounded-lg bg-surface-light dark:bg-surface-dark text-text-light dark:text-text-dark focus:outline-none focus:ring-2 focus:ring-primary-DEFAULT" />
<button type="submit" id="send-button" 
class="px-4 py-2 text-sm bg-primary-DEFAULT hover:bg-primary-dark text-white rounded-lg transition-colors">
Send
</button>
</div>
</form>
</aside>
</div>
</div>

<script>
    const chatPanel = document.getElementById('chat-panel');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const newChatButton = document.getElementById('new-chat-button');
    const RECAPTCHA_SITE_KEY = '6LcQhFMrAAAAAMjWClxXSNDpZrFZj3rUrz5UHhWA';
    const modelSelector = document.getElementById('model-selector');

    // Chat panel toggle functionality
    const toggleChatBtn = document.getElementById('toggle-chat');
    const closeChatBtn = document.getElementById('close-chat');
    const chatSidebar = document.getElementById('chat-sidebar');
    const mainContent = document.getElementById('main-content');

    let isChatVisible = true;

    function toggleChatPanel() {
        isChatVisible = !isChatVisible;
        
        if (isChatVisible) {
            chatSidebar.classList.remove('collapsed');
            toggleChatBtn.classList.remove('collapsed');
        } else {
            chatSidebar.classList.add('collapsed');
            toggleChatBtn.classList.add('collapsed');
        }
    }

    toggleChatBtn.addEventListener('click', toggleChatPanel);
    closeChatBtn.addEventListener('click', toggleChatPanel);

    let chatHistory = [];
    let lastUserMessageText = '';
    let isRetryMode = false;
    let currentBotMessageDiv = null;
    let letterAnimationTimeouts = []; 
    let stopLetterAnimationGlobal = false; 
    let fetchAbortController = null;
    let currentStopButtonHandler = null;
    let botMessageSpanForAnimation = null; 
    let combinedTextContentForAnimation = '';

    // New Chat button functionality
    newChatButton.addEventListener('click', () => {
        chatHistory = [];
        lastUserMessageText = '';
        isRetryMode = false;
        chatPanel.innerHTML = '';
        chatInput.value = '';
        stopLetterAnimationGlobal = true;
        letterAnimationTimeouts.forEach(clearTimeout);
        letterAnimationTimeouts = [];
        
        if (fetchAbortController) {
            fetchAbortController.abort();
            fetchAbortController = null;
        }
        
        if (currentStopButtonHandler) {
            sendButton.removeEventListener('click', currentStopButtonHandler);
            currentStopButtonHandler = null;
        }
        sendButton.textContent = 'Send';
        sendButton.disabled = false;
        chatInput.disabled = false;
        stopLetterAnimationGlobal = false;
    });

    function formatBotMessage(text) {
        const html = DOMPurify.sanitize(marked.parse(text), {
            ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'code', 'pre', 'blockquote', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'a', 'img', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'del', 'mark', 'span', 'div'],
            ALLOWED_ATTR: ['href', 'title', 'target', 'rel', 'src', 'alt', 'width', 'height', 'class', 'id'],
            ALLOW_DATA_ATTR: false,
            ADD_ATTR: ['target'],
        });
        return html;
    }

    function applySyntaxHighlighting(element) {
        if (typeof Prism !== 'undefined') {
            const codeBlocks = element.querySelectorAll('pre code');
            codeBlocks.forEach(block => {
                Prism.highlightElement(block);
            });
        }
    }
    
    function displayMessage(sender, textOrHtml, isHtml = false) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', sender.toLowerCase());

        const senderSpan = document.createElement('div');
        senderSpan.classList.add('message-sender');
        senderSpan.textContent = sender === 'User' ? 'You' : 'Bot';
        messageDiv.appendChild(senderSpan);

        const contentDiv = document.createElement('div');
        contentDiv.classList.add('message-content');
        if (isHtml) {
            contentDiv.innerHTML = textOrHtml;
        } else {
            contentDiv.textContent = textOrHtml;
        }
        messageDiv.appendChild(contentDiv);
        
        chatPanel.appendChild(messageDiv);
        chatPanel.scrollTop = chatPanel.scrollHeight;

        return messageDiv;
    }

    chatForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const selectedModel = modelSelector.value;

        let userMessageToProcess;

        if (isRetryMode) {
            userMessageToProcess = lastUserMessageText;
            isRetryMode = false; 
        } else {
            userMessageToProcess = chatInput.value.trim();
            if (!userMessageToProcess) return;
            lastUserMessageText = userMessageToProcess;
            displayMessage('User', userMessageToProcess);
            chatHistory.push({ role: "user", parts: [{ text: userMessageToProcess }] });
        }

        chatInput.value = '';
        chatInput.disabled = true;
        sendButton.disabled = true;

        grecaptcha.enterprise.ready(function() {
            grecaptcha.enterprise.execute(RECAPTCHA_SITE_KEY, {action: 'submit'})
                .then(async function(token) {
                    function wrapTextNodesWithLetterSpans(element) {
                        const letters = [];
                        Array.from(element.childNodes).forEach(child => {
                            if (child.nodeType === Node.TEXT_NODE) {
                                const text = child.textContent;
                                if (text.trim() === '') return;
                                const fragment = document.createDocumentFragment();
                                for (let i = 0; i < text.length; i++) {
                                    const span = document.createElement('span');
                                    span.className = 'anim-letter';
                                    span.textContent = text[i];
                                    fragment.appendChild(span);
                                    letters.push(span);
                                }
                                child.parentNode.replaceChild(fragment, child);
                            } else if (child.nodeType === Node.ELEMENT_NODE) {
                                letters.push(...wrapTextNodesWithLetterSpans(child));
                            }
                        });
                        return letters;
                    }

                    currentBotMessageDiv = displayMessage('Bot', '<img src="assets/thinking.gif" alt="Thinking..." class="thinking-gif" />', true);
                    const botContentDiv = currentBotMessageDiv.querySelector('.message-content');

                    stopLetterAnimationGlobal = false;
                    letterAnimationTimeouts.forEach(clearTimeout);
                    letterAnimationTimeouts = [];
                    if (currentStopButtonHandler) {
                        sendButton.removeEventListener('click', currentStopButtonHandler);
                        currentStopButtonHandler = null;
                    }
                    fetchAbortController = new AbortController();
                    botMessageSpanForAnimation = null; 
                    combinedTextContentForAnimation = '';

                    function handleStopAction() {
                        stopLetterAnimationGlobal = true; 
                        letterAnimationTimeouts.forEach(clearTimeout);
                        letterAnimationTimeouts = [];

                        if (fetchAbortController) {
                            fetchAbortController.abort(); 
                        }

                        if (combinedTextContentForAnimation && combinedTextContentForAnimation.trim() !== '' && botContentDiv) {
                            if (botMessageSpanForAnimation) {
                                const allLetters = botMessageSpanForAnimation.querySelectorAll('.anim-letter');
                                allLetters.forEach(s => s.style.opacity = '1');
                            } else { 
                                botContentDiv.innerHTML = ''; 
                                const tempSpan = document.createElement('span');
                                tempSpan.classList.add('bot-typing-content', 'fade-in'); 
                                botContentDiv.appendChild(tempSpan);
                                tempSpan.innerHTML = formatBotMessage(combinedTextContentForAnimation);
                                applySyntaxHighlighting(tempSpan);
                            }
                        } else if (botContentDiv) {
                            botContentDiv.innerHTML = ''; 
                        }

                        chatInput.disabled = false;
                        sendButton.textContent = 'Send';
                        sendButton.disabled = false;
                        isRetryMode = false;
                        if (currentStopButtonHandler) {
                            sendButton.removeEventListener('click', currentStopButtonHandler);
                            currentStopButtonHandler = null;
                        }
                        fetchAbortController = null; 
                    }

                    currentStopButtonHandler = handleStopAction;
                    sendButton.textContent = 'STOP';
                    sendButton.disabled = false; 
                    sendButton.addEventListener('click', currentStopButtonHandler);

                    try {
                        let requestPayload = {
                            history: chatHistory,
                            recaptchaToken: token,
                            model: selectedModel,
                            task: 'chat'
                        };

                        const response = await fetch('/api/gemini-proxy', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestPayload),
                            signal: fetchAbortController.signal
                        });

                        const activeFetchController = fetchAbortController;
                        fetchAbortController = null;

                        if (stopLetterAnimationGlobal && activeFetchController && activeFetchController.signal.aborted) {
                            return; 
                        }

                        const data = await response.json();

                        if (!response.ok) {
                            const errorMessage = data.error?.message || data.error || response.statusText || 'An unknown error occurred';
                            if (botContentDiv) botContentDiv.innerHTML = formatBotMessage(`Error - ${errorMessage}`);
                            if (botContentDiv) applySyntaxHighlighting(botContentDiv);
                            console.error('Error from API:', data);
                            sendButton.textContent = 'Retry';
                            isRetryMode = true;
                            chatInput.disabled = false;
                            sendButton.disabled = false;
                            if (currentStopButtonHandler) {
                                sendButton.removeEventListener('click', currentStopButtonHandler);
                                currentStopButtonHandler = null;
                            }
                            return;
                        }
                        
                        isRetryMode = false; 

                        const responseParts = data.candidates?.[0]?.content?.parts;

                        if (responseParts && responseParts.length > 0) {
                            if (botContentDiv) botContentDiv.innerHTML = ''; 

                            combinedTextContentForAnimation = '';

                            responseParts.forEach(part => {
                                if (part.text) combinedTextContentForAnimation += part.text;
                            });

                            if (stopLetterAnimationGlobal) {
                                if (combinedTextContentForAnimation.trim() !== '' && botContentDiv) {
                                    const tempSpan = document.createElement('span');
                                    tempSpan.classList.add('bot-typing-content', 'fade-in');
                                    botContentDiv.appendChild(tempSpan);
                                    tempSpan.innerHTML = formatBotMessage(combinedTextContentForAnimation);
                                    applySyntaxHighlighting(tempSpan);
                                }
                                return;
                            }

                            if (combinedTextContentForAnimation.trim() !== '') {
                                botMessageSpanForAnimation = document.createElement('span');
                                botMessageSpanForAnimation.classList.add('bot-typing-content');
                                if (botContentDiv) botContentDiv.appendChild(botMessageSpanForAnimation);
                                
                                requestAnimationFrame(() => {
                                    if(botMessageSpanForAnimation) botMessageSpanForAnimation.classList.add('fade-in');
                                });

                                const finalHtml = formatBotMessage(combinedTextContentForAnimation);
                                botMessageSpanForAnimation.innerHTML = finalHtml;
                                applySyntaxHighlighting(botMessageSpanForAnimation);

                                const letterSpans = wrapTextNodesWithLetterSpans(botMessageSpanForAnimation);

                                stopLetterAnimationGlobal = false;

                                if (letterSpans.length > 0) {
                                    letterSpans.forEach((span, index) => {
                                        const timeoutId = setTimeout(() => {
                                            if (stopLetterAnimationGlobal) return;
                                            span.style.opacity = '1';
                                            if (index === letterSpans.length - 1) {
                                                sendButton.textContent = 'Send';
                                                chatInput.disabled = false;
                                                sendButton.disabled = false;
                                                if (currentStopButtonHandler) sendButton.removeEventListener('click', currentStopButtonHandler);
                                                currentStopButtonHandler = null;
                                                letterAnimationTimeouts = [];
                                            }
                                        }, index * (letterSpans.length > 0 ? (Math.max(250, Math.min(5000, letterSpans.length * 50))) / letterSpans.length : 0) );
                                        letterAnimationTimeouts.push(timeoutId);
                                    });
                                } else {
                                    sendButton.textContent = 'Send';
                                    chatInput.disabled = false;
                                    sendButton.disabled = false;
                                    if (currentStopButtonHandler) sendButton.removeEventListener('click', currentStopButtonHandler);
                                    currentStopButtonHandler = null;
                                }

                            } else {
                                if (botContentDiv) botContentDiv.innerHTML = formatBotMessage('Received an empty response.');
                                sendButton.textContent = 'Send';
                                chatInput.disabled = false; 
                                sendButton.disabled = false;
                                if (currentStopButtonHandler) sendButton.removeEventListener('click', currentStopButtonHandler);
                                currentStopButtonHandler = null;
                            }

                        } else {
                            if (botContentDiv) botContentDiv.innerHTML = formatBotMessage('Received a response, but no content parts were found.');
                            sendButton.textContent = 'Send';
                            chatInput.disabled = false; 
                            sendButton.disabled = false;
                            if (currentStopButtonHandler) sendButton.removeEventListener('click', currentStopButtonHandler);
                            currentStopButtonHandler = null;
                        }
                    } catch (error) {
                        if (fetchAbortController) fetchAbortController = null;
                                    
                        if (error.name === 'AbortError') {
                            console.log('Fetch aborted by user action.');
                        } else {
                            if (botContentDiv) botContentDiv.innerHTML = formatBotMessage('Error - Could not connect to the API.');
                            if (botContentDiv) applySyntaxHighlighting(botContentDiv);
                            console.error('Failed to fetch from /api/gemini-proxy:', error);
                            sendButton.textContent = 'Retry';
                            isRetryMode = true;
                            chatInput.disabled = false;
                            sendButton.disabled = false;
                            if (currentStopButtonHandler) {
                                sendButton.removeEventListener('click', currentStopButtonHandler);
                                currentStopButtonHandler = null;
                            }
                        }
                    }
                })
                .catch(function(recaptchaError) {
                    console.error('reCAPTCHA execution failed:', recaptchaError);
                    const errorBotMessageDiv = displayMessage('Bot', formatBotMessage('Error: reCAPTCHA verification failed. Please refresh and try again.'), true);
                    if (errorBotMessageDiv) { 
                        const errorBotContentDiv = errorBotMessageDiv.querySelector('.message-content');
                        if (errorBotContentDiv) { 
                            applySyntaxHighlighting(errorBotContentDiv);
                        }
                    }

                    chatInput.disabled = false;
                    sendButton.disabled = false;
                    sendButton.textContent = 'Send';
                    isRetryMode = false;
                    if (currentStopButtonHandler) {
                        sendButton.removeEventListener('click', currentStopButtonHandler);
                        currentStopButtonHandler = null;
                    }
                });
        });
    });
</script>

</body></html>
